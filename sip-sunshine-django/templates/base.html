{% load i18n static %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    {% if page.meta_title %}
        <title>{{ page.meta_title }}</title>
    {% else %}
        <title>{% block title %}Sip and SunShine - Restaurant{% endblock %}</title>
    {% endif %}
    
    {% if page.meta_description %}
        <meta name="description" content="{{ page.meta_description }}">
    {% else %}
        <meta name="description" content="{{ site_settings.site_description }}">
    {% endif %}
    
    {% if page.meta_keywords %}
        <meta name="keywords" content="{{ page.meta_keywords }}">
    {% else %}
        <meta name="keywords" content="{{ site_settings.site_keywords }}">
    {% endif %}
    
    <meta name="theme-color" content="#ffc400">
    
    {% if site_settings.site_favicon %}
        <link rel="icon" type="image/png" href="{{ site_settings.site_favicon.url }}">
    {% endif %}
    
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <!-- Animate CSS -->
    <link rel="stylesheet" href="{% static 'css/animate.css' %}">
    <!-- Icomoon Font -->
    <link rel="stylesheet" href="{% static 'fonts/icomoon/style.css' %}">
    <!-- Ionicons -->
    <link rel="stylesheet" href="{% static 'css/ionicons.min.css' %}">
    <!-- Bootstrap Datepicker -->
    <link rel="stylesheet" href="{% static 'css/bootstrap-datepicker.css' %}">
    <!-- jQuery Timepicker -->
    <link rel="stylesheet" href="{% static 'css/jquery.timepicker.css' %}">
    <!-- Owl Carousel -->
    <link rel="stylesheet" href="{% static 'css/owl.carousel.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/owl.theme.default.min.css' %}">
    <!-- Magnific Popup -->
    <link rel="stylesheet" href="{% static 'css/magnific-popup.css' %}">
    <!-- AOS Animation -->
    <link rel="stylesheet" href="{% static 'css/aos.css' %}">
    <!-- Flaticon -->
    <link rel="stylesheet" href="{% static 'css/flaticon.css' %}">
    
    <!-- Main Style -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom-navbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/custom-responsive.css' %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{% static 'images/favicon.svg' %}">
    
    {% block extra_css %}{% endblock %}
</head>
<body
    class="{% if request.resolver_match and request.resolver_match.url_name == 'home' %}home-page{% else %}inner-page{% endif %}"
    data-user-logged-in="{% if user.is_authenticated %}true{% else %}false{% endif %}"
    data-user-id="{% if user.is_authenticated %}{{ user.id }}{% endif %}"
    data-user-email="{% if user.is_authenticated %}{{ user.email }}{% endif %}"
    data-user-name="{% if user.is_authenticated %}{% if user.get_full_name %}{{ user.get_full_name }}{% else %}{{ user.username }}{% endif %}{% endif %}"
    data-user-phone="{% if user.is_authenticated and profile %}{{ profile.phone }}{% endif %}"
    data-user-delivery-address="{% if user.is_authenticated and profile %}{{ profile.delivery_address }}{% endif %}"
    data-user-delivery-city="{% if user.is_authenticated and profile %}{{ profile.delivery_city }}{% endif %}"
    data-user-delivery-postal-code="{% if user.is_authenticated and profile %}{{ profile.delivery_postal_code }}{% endif %}"
    data-user-delivery-country="{% if user.is_authenticated and profile %}{{ profile.delivery_country }}{% endif %}"
    data-user-payment-method="{% if user.is_authenticated and profile %}{{ profile.preferred_payment_method }}{% endif %}"
>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-xl navbar-dark ftco_navbar bg-dark ftco-navbar-light" id="ftco-navbar">
        <div class="container">
            {% if site_settings.site_logo %}
                <a class="navbar-brand" href="{% url 'restaurant:home' %}">
                    <img src="{{ site_settings.site_logo.url }}" alt="{{ site_settings.site_name }}" style="max-height: 50px;">
                </a>
            {% else %}
                <a class="navbar-brand d-flex align-items-center" href="{% url 'restaurant:home' %}">
                    <img src="{% static 'images/logo.svg' %}" alt="{{ site_settings.site_name }}" style="max-height: 50px; margin-right: 10px;">
                    <span class="d-none d-md-inline">{{ site_settings.site_name }}</span>
                </a>
            {% endif %}
            
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#ftco-nav" aria-controls="ftco-nav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="oi oi-menu"></span> {% trans "Menu" %}
            </button>

            <div class="collapse navbar-collapse" id="ftco-nav">
                <div class="w-100 d-xl-flex align-items-center justify-content-between">
                    <ul class="navbar-nav">
                        <li class="nav-item"><a href="{% url 'restaurant:home' %}" class="nav-link">{% trans "Home" %}</a></li>
                        <li class="nav-item"><a href="{% url 'restaurant:about' %}" class="nav-link">{% trans "About" %}</a></li>
                        <li class="nav-item"><a href="{% url 'restaurant:menu' %}" class="nav-link">{% trans "Menu" %}</a></li>
                        <li class="nav-item"><a href="{% url 'restaurant:blog' %}" class="nav-link">{% trans "Blog" %}</a></li>
                        <li class="nav-item"><a href="{% url 'restaurant:contact' %}" class="nav-link">{% trans "Contact" %}</a></li>
                        <li class="nav-item"><a href="{% url 'restaurant:reservation' %}" class="nav-link">{% trans "Reservation" %}</a></li>
                    </ul>

                    <ul class="navbar-nav mt-2 mt-xl-0">
                    <!-- Cart + Checkout -->
                    <li class="nav-item">
                        <a href="#" class="nav-link d-flex align-items-center" id="cartIcon" onclick="return false;">
                            <span style="position: relative; display: inline-block; margin-right: 6px;">
                                <span class="ion-ios-cart" aria-hidden="true"></span>
                                <span id="cartItemCount" style="display:none; position: absolute; top: -6px; right: -10px; background: #f34949; color: #fff; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 999px; font-size: 11px; align-items: center; justify-content: center;">0</span>
                            </span>
                            {% trans "Cart" %}
                        </a>
                    </li>

                    <!-- Customer Auth -->
                    {% if user.is_authenticated %}
                        <li class="nav-item"><a href="{% url 'restaurant:customer_profile' %}" class="nav-link">{% trans "Profile" %}</a></li>
                        <li class="nav-item"><a href="{% url 'restaurant:customer_logout' %}" class="nav-link">{% trans "Logout" %}</a></li>
                    {% else %}
                        <li class="nav-item"><a href="{% url 'restaurant:customer_login' %}" class="nav-link">{% trans "Login" %}</a></li>
                        <li class="nav-item"><a href="{% url 'restaurant:customer_register' %}" class="nav-link">{% trans "Register" %}</a></li>
                    {% endif %}
                    
                    <!-- Language Selector -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="languageDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span id="current-lang">{{ current_language|upper }}</span>
                        </a>
                        <div class="dropdown-menu" aria-labelledby="languageDropdown">
                            {% for lang in active_languages %}
                                <a class="dropdown-item" href="javascript:switchLanguage('{{ lang.code }}');">{{ lang.name }}</a>
                            {% endfor %}
                        </div>
                    </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>
    <!-- END nav -->

    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% block content %}{% endblock %}

    <!-- Cart Modal (available site-wide) -->
    {% include 'cart/cart_modal.html' %}

    <!-- Footer -->
    <footer class="ftco-footer ftco-bg-dark ftco-section">
        <div class="container">
            <div class="row mb-5">
                <!-- Logo and About Section -->
                <div class="col-md-6 col-lg-3">
                    <div class="ftco-footer-widget mb-4">
                        <div class="mb-3">
                            {% if site_settings.site_logo %}
                                <img src="{{ site_settings.site_logo.url }}" alt="{{ site_settings.site_name }}" style="max-height: 60px; margin-bottom: 15px;">
                            {% else %}
                                <img src="{% static 'images/logo.svg' %}" alt="{{ site_settings.site_name }}" style="max-height: 60px; margin-bottom: 15px;">
                            {% endif %}
                        </div>
                        <h2 class="ftco-heading-2">{{ site_settings.site_name }}</h2>
                        <p>{{ site_settings.site_description }}</p>
                        <ul class="ftco-footer-social list-unstyled float-md-left float-lft mt-3">
                            {% if site_settings.facebook_url %}
                                <li class="ftco-animate"><a href="{{ site_settings.facebook_url }}" target="_blank" rel="noopener noreferrer"><span class="icon-facebook"></span></a></li>
                            {% endif %}
                            {% if site_settings.twitter_url %}
                                <li class="ftco-animate"><a href="{{ site_settings.twitter_url }}" target="_blank" rel="noopener noreferrer"><span class="icon-twitter"></span></a></li>
                            {% endif %}
                            {% if site_settings.instagram_url %}
                                <li class="ftco-animate"><a href="{{ site_settings.instagram_url }}" target="_blank" rel="noopener noreferrer"><span class="icon-instagram"></span></a></li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                
                <!-- Open Hours Section -->
                <div class="col-md-6 col-lg-3">
                    <div class="ftco-footer-widget mb-4">
                        <h2 class="ftco-heading-2">{% trans "Open Hours" %}</h2>
                        <ul class="list-unstyled open-hours">
                            <li class="d-flex"><span>{% trans "Monday" %}</span><span>11:00 AM - 10:00 PM</span></li>
                            <li class="d-flex"><span>{% trans "Tuesday" %}</span><span>11:00 AM - 10:00 PM</span></li>
                            <li class="d-flex"><span>{% trans "Wednesday" %}</span><span>11:00 AM - 10:00 PM</span></li>
                            <li class="d-flex"><span>{% trans "Thursday" %}</span><span>11:00 AM - 10:00 PM</span></li>
                            <li class="d-flex"><span>{% trans "Friday" %}</span><span>11:00 AM - 11:00 PM</span></li>
                            <li class="d-flex"><span>{% trans "Saturday" %}</span><span>11:00 AM - 11:00 PM</span></li>
                            <li class="d-flex"><span>{% trans "Sunday" %}</span><span>12:00 PM - 10:00 PM</span></li>
                        </ul>
                    </div>
                </div>
                
                <!-- Contact Info Section -->
                <div class="col-md-6 col-lg-3">
                    <div class="ftco-footer-widget mb-4">
                        <h2 class="ftco-heading-2">{% trans "Contact" %}</h2>
                        <div class="block-23 mb-3">
                            <ul>
                                <li><span class="icon icon-map-marker"></span><span class="text">{{ site_settings.address }}</span></li>
                                <li><a href="tel:{{ site_settings.phone }}"><span class="icon icon-phone"></span><span class="text">{{ site_settings.phone }}</span></a></li>
                                <li><a href="mailto:{{ site_settings.email }}"><span class="icon icon-envelope"></span><span class="text">{{ site_settings.email }}</span></a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom Footer -->
            <div class="row border-top pt-5 mt-5">
                <div class="col-md-6 col-lg-8">
                    <p class="copyright">
                        Copyright &copy; <script>document.write(new Date().getFullYear());</script> 
                        <strong>{{ site_settings.site_name }}</strong> | {% trans "All rights reserved" %}
                    </p>
                </div>
                <div class="col-md-6 col-lg-4 text-right">
                    <p>
                        <a href="{% url 'restaurant:home' %}" class="mr-3">{% trans "Home" %}</a>
                        <a href="{% url 'restaurant:about' %}" class="mr-3">{% trans "About" %}</a>
                        <a href="{% url 'restaurant:menu' %}" class="mr-3">{% trans "Menu" %}</a>
                        <a href="{% url 'restaurant:contact' %}" class="mr-3">{% trans "Contact" %}</a>
                        <a href="{% url 'admin:index' %}" class="admin-link" title="Admin Portal" style="color: #f34949; font-weight: 600;">
                            <span class="icon icon-lock"></span> {% trans "Admin" %}
                        </a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Chatbot (floating widget) -->
    <div id="sipChatWidget" style="position: fixed; right: 18px; bottom: 18px; z-index: 9999;">
        <button id="sipChatToggle" type="button" style="
            width: 54px;
            height: 54px;
            border-radius: 999px;
            border: none;
            background: #f34949;
            color: white;
            font-weight: 700;
            box-shadow: 0 10px 25px rgba(0,0,0,0.25);
            cursor: pointer;
        " title="Chat">
            ðŸ’¬
        </button>

        <div id="sipChatPanel" style="
            display: none;
            width: 320px;
            max-width: calc(100vw - 36px);
            height: 420px;
            margin-bottom: 12px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            border: 1px solid #e0e0e0;
        ">
            <div style="
                background: linear-gradient(135deg, #f34949 0%, #d63d3d 100%);
                color: white;
                padding: 12px 14px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
            ">
                <div style="font-weight: 700;">Assistant</div>
                <button id="sipChatClose" type="button" style="
                    border: none;
                    background: rgba(255,255,255,0.25);
                    color: white;
                    border-radius: 6px;
                    width: 34px;
                    height: 34px;
                    cursor: pointer;
                ">Ã—</button>
            </div>

            <div id="sipChatMessages" style="padding: 14px; height: 310px; overflow-y: auto; background: #fafafa;"></div>

            <div style="padding: 12px; border-top: 1px solid #e0e0e0; background: white;">
                <form id="sipChatForm" style="display: flex; gap: 8px; align-items: center; margin: 0;">
                    <input id="sipChatInput" type="text" placeholder="Ask a questionâ€¦" style="
                        flex: 1;
                        padding: 10px 12px;
                        border: 1px solid #e0e0e0;
                        border-radius: 8px;
                        outline: none;
                    "/>
                    <button type="submit" style="
                        padding: 10px 14px;
                        border: none;
                        border-radius: 8px;
                        background: #f34949;
                        color: white;
                        font-weight: 700;
                        cursor: pointer;
                    ">Send</button>
                </form>
                <div style="margin-top: 8px; font-size: 11px; color: #999;">
                    Tip: ask about delivery, pickup, hours, reservations, payment, tracking.
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="{% static 'js/jquery-migrate-3.0.1.min.js' %}"></script>
    <!-- Bootstrap JS -->
    <script src="{% static 'js/popper.min.js' %}"></script>
    <script src="{% static 'js/bootstrap.min.js' %}"></script>
    <!-- Bootstrap Datepicker -->
    <script src="{% static 'js/bootstrap-datepicker.js' %}"></script>
    <!-- jQuery Timepicker -->
    <script src="{% static 'js/jquery.timepicker.min.js' %}"></script>
    <!-- Owl Carousel -->
    <script src="{% static 'js/owl.carousel.min.js' %}"></script>
    <!-- Magnific Popup -->
    <script src="{% static 'js/jquery.magnific-popup.min.js' %}"></script>
    <!-- AOS Animation -->
    <script src="{% static 'js/aos.js' %}"></script>
    <!-- Waypoints -->
    <script src="{% static 'js/jquery.waypoints.min.js' %}"></script>
    <!-- Animate Number -->
    <script src="{% static 'js/jquery.animateNumber.min.js' %}"></script>
    <!-- Scrollax -->
    <script src="{% static 'js/scrollax.min.js' %}"></script>
    <!-- Stellar JS -->
    <script src="{% static 'js/jquery.stellar.min.js' %}"></script>
    <!-- Main JS -->
    <script src="{% static 'js/main.js' %}"></script>

    <!-- Cart System JS (enables Cart modal + badge) -->
    <script src="{% static 'js/cart-system.js' %}"></script>
    
    {% block extra_js %}{% endblock %}
    
    <script>
    // Global function to handle language switching
    window.switchLanguage = function(langCode) {
        // Create form dynamically
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '/i18n/setlang/';
        form.style.display = 'none';
        
        // Add language input
        var langInput = document.createElement('input');
        langInput.type = 'hidden';
        langInput.name = 'language';
        langInput.value = langCode;
        form.appendChild(langInput);
        
        // Add next parameter to redirect to appropriate page after language change
        var nextInput = document.createElement('input');
        nextInput.type = 'hidden';
        nextInput.name = 'next';
        // Get current path and adjust for language prefix
        var currentPath = window.location.pathname;
        var pathSegments = currentPath.split('/').filter(function(s) { return s.length > 0; });
        
        // Check if first segment is a language code and remove it
        var langs = ['en', 'nl', 'fr'];
        if (pathSegments.length > 0 && langs.indexOf(pathSegments[0]) !== -1) {
            pathSegments.shift();
        }
        
        // Build new path with language prefix (if not English, since English has no prefix)
        var newPath = '/';
        if (langCode !== 'en') {
            newPath += langCode + '/';
        }
        newPath += pathSegments.join('/');
        if (pathSegments.length > 0) {
            newPath += '/';
        }
        
        nextInput.value = newPath;
        form.appendChild(nextInput);
        
        // Add CSRF token - try multiple methods
        var csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        
        // Try to get from DOM
        var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken && csrfToken.value) {
            csrfInput.value = csrfToken.value;
        } else {
            // Try to get from cookie
            var name = 'csrftoken';
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            if (cookieValue) {
                csrfInput.value = cookieValue;
            }
        }
        form.appendChild(csrfInput);
        
        // Append form to body and submit
        document.body.appendChild(form);
        form.submit();
    };
    
    // Update language display
    document.addEventListener('DOMContentLoaded', function() {
        var currentLangSpan = document.getElementById('current-lang');
        if (currentLangSpan) {
            currentLangSpan.textContent = '{{ current_language|upper }}';
        }
    });
    </script>

    <script>
    (function() {
        const toggleBtn = document.getElementById('sipChatToggle');
        const panel = document.getElementById('sipChatPanel');
        const closeBtn = document.getElementById('sipChatClose');
        const messagesEl = document.getElementById('sipChatMessages');
        const form = document.getElementById('sipChatForm');
        const input = document.getElementById('sipChatInput');

        if (!toggleBtn || !panel || !closeBtn || !messagesEl || !form || !input) return;

        function esc(s) {
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function getCookie(name) {
            const cookies = document.cookie ? document.cookie.split(';') : [];
            for (let i = 0; i < cookies.length; i++) {
                const c = cookies[i].trim();
                if (c.startsWith(name + '=')) {
                    return decodeURIComponent(c.substring(name.length + 1));
                }
            }
            return null;
        }

        function addMessage(role, text) {
            const wrapper = document.createElement('div');
            wrapper.style.marginBottom = '10px';
            wrapper.style.display = 'flex';
            wrapper.style.justifyContent = role === 'user' ? 'flex-end' : 'flex-start';

            const bubble = document.createElement('div');
            bubble.style.maxWidth = '85%';
            bubble.style.padding = '10px 12px';
            bubble.style.borderRadius = '10px';
            bubble.style.whiteSpace = 'pre-wrap';
            bubble.style.fontSize = '13px';
            bubble.style.lineHeight = '1.4';
            bubble.style.background = role === 'user' ? '#f34949' : '#ffffff';
            bubble.style.color = role === 'user' ? '#ffffff' : '#1a1a1a';
            bubble.style.border = role === 'user' ? 'none' : '1px solid #e0e0e0';
            bubble.innerHTML = esc(text);

            wrapper.appendChild(bubble);
            messagesEl.appendChild(wrapper);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function open() {
            panel.style.display = 'block';
            toggleBtn.style.display = 'none';
            if (!messagesEl.dataset.greeted) {
                addMessage('bot', 'Hi! Ask me about delivery, pickup, reservations, payment, or tracking.');
                messagesEl.dataset.greeted = '1';
            }
            setTimeout(() => input.focus(), 50);
        }

        function close() {
            panel.style.display = 'none';
            toggleBtn.style.display = 'inline-block';
        }

        toggleBtn.addEventListener('click', open);
        closeBtn.addEventListener('click', close);

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const text = (input.value || '').trim();
            if (!text) return;
            input.value = '';
            addMessage('user', text);

            try {
                const res = await fetch('/api/chatbot/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken') || '',
                    },
                    body: JSON.stringify({ message: text }),
                });

                const data = await res.json().catch(() => ({}));
                if (!res.ok || !data.success) {
                    addMessage('bot', data.message || 'Sorry, something went wrong.');
                    return;
                }
                addMessage('bot', data.reply || 'How can I help?');
            } catch (err) {
                addMessage('bot', 'Network error. Please try again.');
            }
        });
    })();
    </script>
</body>
</html>
